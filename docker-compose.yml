version: '3.8'

services:
  mcp-madrid-transport:
    build:
      context: .
      dockerfile: Dockerfile
    image: mcp-madrid-transport:latest
    container_name: mcp-madrid-transport
    restart: unless-stopped

    ports:
      - "3000:3000"

    environment:
      # Debug settings
      - DEBUG=${DEBUG:-false}
      - DEBUG_LEVEL=${DEBUG_LEVEL:-info}

      # EMT API credentials (REQUIRED)
      - EMT_CLIENT_ID=${EMT_CLIENT_ID}
      - EMT_PASS_KEY=${EMT_PASS_KEY}

      # API endpoints (optional overrides)
      - METRO_API_URL=${METRO_API_URL:-https://serviciosapp.metromadrid.es}
      - EMT_API_URL=${EMT_API_URL:-https://openapi.emtmadrid.es}

      # Cache TTL settings (in seconds)
      - CACHE_TTL_METRO=${CACHE_TTL_METRO:-30}
      - CACHE_TTL_BUS=${CACHE_TTL_BUS:-10}
      - CACHE_TTL_TRAIN=${CACHE_TTL_TRAIN:-10}

      # HTTP server settings
      - MCP_HTTP_PORT=${MCP_HTTP_PORT:-3000}
      - MCP_HTTP_HOST=${MCP_HTTP_HOST:-0.0.0.0}

      # GTFS data path (inside container)
      - GTFS_DATA_PATH=/app/transport-data

    volumes:
      # Optional: Persist logs
      - ./logs:/app/logs

      # Optional: Persist SQLite database
      - ./data:/app/data

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    networks:
      - mcp-network

networks:
  mcp-network:
    driver: bridge
